
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
    function isSignedIn() {
      return request.auth != null;
    }

    // ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ุนุถู ูู ูุญุงุฏุซุฉ ูุนููุฉ
    function isMember(chatId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/chats/$(chatId))
        && get(/databases/$(database)/documents/chats/$(chatId)).data.members[request.auth.uid] == true;
    }

    // ๐น ูุงุนุฏุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู
    match /users/{userId} {
      // ุงููุณุชุฎุฏู ูุณุชุทูุน ุชุนุฏูู ุจูุงูุงุชู ููุท
      allow write: if request.auth.uid == userId;
      // ุฌููุน ุงููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู ูููููู ูุฑุงุกุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู (ูุซูุงู ุงูุงุณู ุฃู ุงูุตูุฑุฉ)
      allow read: if isSignedIn();
    }

    // ๐น ูุงุนุฏุฉ ุจูุงูุงุช ุงููุญุงุฏุซุงุช
    match /chats/{chatId} {
      // ุงูุณูุงุญ ุจูุฑุงุกุฉ ุงููุญุงุฏุซุฉ ููุท ููุฃุนุถุงุก
      allow read: if isMember(chatId);
      // ุงูุณูุงุญ ุจุงูุชุญุฏูุซ ููุท ููุฃุนุถุงุก (ูุซูุงู ุขุฎุฑ ุฑุณุงูุฉ)
      allow update: if isMember(chatId);
      // ุงูุณูุงุญ ุจุฅูุดุงุก ูุญุงุฏุซุฉ ูุฃู ูุณุชุฎุฏู ูุตุงุฏู ุนููู
      allow create: if isSignedIn();
      // ูุง ููุณูุญ ุจุงูุญุฐู ูู ุงูุนููู
      allow delete: if false;

      // ๐น ูุงุนุฏุฉ ุจูุงูุงุช ุงูุฑุณุงุฆู ุฏุงุฎู ูู ูุญุงุฏุซุฉ
      match /messages/{messageId} {
        // ุงูุณูุงุญ ุจูุฑุงุกุฉ ุงูุฑุณุงุฆู ููุฃุนุถุงุก ููุท
        allow read: if isMember(chatId);
        // ุงูุณูุงุญ ุจุฅูุดุงุก ุฑุณุงูุฉ ููุท ููุฃุนุถุงุก ููุฌุจ ุฃู ูููู ุงููุฑุณู ูู ููุณู ุงููุณุชุฎุฏู ุงูุญุงูู
        allow create: if isMember(chatId) && request.resource.data.senderId == request.auth.uid;
        // ููุน ุงูุชุนุฏูู ุฃู ุงูุญุฐู ุงููุจุงุดุฑ ูู ุงูุนููู
        allow update, delete: if false;
      }
    }

    // ๐น ูุงุนุฏุฉ ุจูุงูุงุช ุงูููุฎุตุงุช ุงูุฎุงุตุฉ ุจูู ูุณุชุฎุฏู (ุงุฎุชูุงุฑู)
    match /userChats/{userId}/{doc=**} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }
  }
}
