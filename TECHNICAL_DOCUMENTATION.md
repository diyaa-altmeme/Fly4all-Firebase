# المستند الفني لنظام Mudarib Accounting

## 1. نظرة عامة

هذا المستند يقدم شرحًا فنيًا شاملاً لنظام "Mudarib Accounting"، وهو نظام محاسبي متكامل مصمم خصيصًا لشركات السفر والسياحة. يهدف هذا الملف إلى توفير مرجع موحد للمطورين لتسهيل عمليات الصيانة، التحسين، والتطوير المستقبلية.

---

## 2. الصفحات الرئيسية ووظائفها

### 2.1. لوحة التحكم (Dashboard)
- **المسار:** `/dashboard`
- **الوظيفة:** توفر نظرة عامة وسريعة على أهم الأنشطة والمؤشرات في النظام.
- **المحتوى:**
    - **بطاقات إحصائيات (Stat Cards):** عرض سريع لأرقام مهمة مثل (حجوزات الشهر، الاشتراكات النشطة، الأرباح، الحوالات المعلقة).
    - **أحدث الحجوزات (Recent Bookings):** قائمة بآخر 7 حجوزات تمت إضافتها.
    - **الأقساط القادمة (Upcoming Installments):** قائمة بأقساط الاشتراكات المستحقة قريبًا.
    - **مخطط الإيرادات (Revenue Chart):** رسم بياني يوضح الإيرادات والأرباح على مدار الأشهر.

### 2.2. إدارة الحجوزات (Bookings)
- **المسار:** `/bookings`
- **الوظيفة:** المركز الرئيسي لإدارة جميع حجوزات الطيران، بما في ذلك إضافتها، تعديلها، وتدقيقها.
- **المحتوى:**
    - **أزرار إجراءات:**
        - "إضافة حجز جديد": يفتح نافذة منبثقة (`Dialog`) تحتوي على نموذج مفصل لإدخال بيانات حجز جديد.
        - "إضافة حجز سريع": يفتح قائمة منسدلة تسمح بالإدخال اليدوي السريع أو "الإدخال الذكي" للتذاكر عبر تحليل ملفات PDF.
    - **أدوات الفلترة والبحث:** حقل بحث عام، مع فلاتر مخصصة (PNR, اسم المسافر, رقم التذكرة, المورد, العميل، العملة).
    - **جدول الحجوزات (`BookingsTable`):**
        - يعرض كل حجز في صف رئيسي قابل للتوسيع.
        - عند توسيع الصف، يظهر جدول فرعي بتفاصيل المسافرين.
        - يتضمن أعمدة مثل (PNR, عدد المسافرين, الجهة المصدرة, المستفيدة, إجمالي الشراء والبيع, الربح, الحالة).
        - قائمة إجراءات (Dropdown) لكل صف تتيح (التعديل, تأكيد الإدخال, التدقيق, الحذف).
    - **نموذج الإدخال السريع (`InlineNewBookingForm`):** يظهر عند الحاجة لإدخال سريع ومباشر في الصفحة.

### 2.3. إدارة المستخدمين والأدوار (Users & Roles)
- **المسار:** `/users`
- **الوظيفة:** إدارة حسابات المستخدمين، صلاحياتهم، وأدوارهم في النظام.
- **المحتوى:**
    - **تبويبات (Tabs):** للتنقل بين "الموظفين" و "أدوار الموظفين" و "صلاحيات العملاء".
    - **قسم المستخدمين:**
        - جدول يعرض جميع المستخدمين (`UsersTable`) مع بياناتهم (الاسم، البريد الإلكتروني، الدور، الحالة).
        - زر "إضافة مستخدم جديد" يفتح نافذة (`Dialog`) مع نموذج لإضافة مستخدم.
        - قائمة إجراءات لكل مستخدم تتيح التعديل والحذف.
    - **قسم الأدوار والصلاحيات (`RolesContent`):**
        - عرض للأدوار المتاحة في النظام (مدير, محرر, مشاهد).
        - عند اختيار دور معين، يتم عرض شجرة صلاحيات (`Permissions Tree`) مفصلة تتيح منح أو سحب صلاحيات محددة لهذا الدور.

### 2.4. سجل السندات (Vouchers)
- **المسار:** `/accounts/vouchers/list`
- **الوظيفة:** مركز إدارة جميع أنواع السندات المالية (قبض، دفع، مصاريف، قيود محاسبية) التي تم توحيدها تحت مجموعة `journal-vouchers`.
- **المحتوى:**
    - **زر إضافة سند جديد:** قائمة منسدلة تتيح للمستخدم اختيار نوع السند الذي يريد إنشاءه (قبض، دفع، مصاريف، قيد محاسبي)، وكل خيار يفتح نافذة `Dialog` مخصصة له.
    - **تبويبات (Tabs):** للتنقل بين جداول عرض الأنواع المختلفة من السندات (الكل، قبض مخصص، قبض عادي، دفع، مصاريف، قيود).
    - **جدول السندات (`VouchersTable`):**
        - يعرض جميع السندات بتنسيق موحد مع إمكانية الفلترة والبحث.
        - أعمدة مثل (رقم الفاتورة, الطرف المقابل, المبلغ, العملة, التاريخ, الموظف).

### 2.5. الإعدادات (Settings)
- **المسار:** `/settings`
- **الوظيفة:** مركز التحكم الشامل في جميع إعدادات التطبيق.
- **المحتوى:**
    - **تبويبات الإعدادات:** مقسمة إلى مجموعات منطقية (المظهر والأصول, الإعدادات المحاسبية, الربط الخارجي, حالة النظام).
    - **نوافذ منبثقة (`Dialog`):** كل قسم إعدادات يتيح تعديل خياراته، مثل:
        - **تخصيص المظهر:** للتحكم في ألوان وخطوط شريط التنقل.
        - **إدارة الأصول:** لرفع وإدارة الصور والشعارات المستخدمة في الموقع.
        - **شجرة الحسابات:** لعرض الدليل المحاسبي.

---

## 3. التقنيات المستخدمة وهيكل الكود

### 3.1. التقنيات الأساسية
- **الواجهة الأمامية (Frontend):**
  - **`Next.js` (مع App Router):** إطار عمل React لتطبيقات الخادم (SSR) والساكنة (SSG).
  - **`React`:** المكتبة الأساسية لبناء واجهات المستخدم.
  - **`TypeScript`:** لإضافة أنواع ثابتة إلى JavaScript وتحسين جودة الكود.

- **التصميم والواجهة (UI & Styling):**
  - **`Tailwind CSS`:** إطار عمل CSS يعتمد على الأدوات (Utility-first) لتصميم سريع ومخصص.
  - **`ShadCN UI`:** مجموعة من مكونات الواجهة القابلة لإعادة الاستخدام، مبنية على Tailwind CSS و Radix UI.
  - **`Lucide React`:** مكتبة أيقونات خفيفة وممتازة.

- **الواجهة الخلفية والخدمات (Backend & Services):**
  - **`Firebase`:** منصة متكاملة تشمل:
    - **`Firestore`:** قاعدة البيانات الرئيسية NoSQL.
    - **`Firebase Storage`:** لتخزين الملفات.
    - **`Firebase Admin SDK`:** للتفاعل مع خدمات Firebase من جانب الخادم (داخل Server Actions).
  - **`Genkit` (من Google AI):** إطار عمل لتسهيل إضافة ميزات الذكاء الاصطناعي، مثل تصنيف السندات وتحليل التذاكر.

- **إدارة الحالة (State Management):**
  - **`React Hooks` (`useState`, `useEffect`, `useContext`):** لإدارة الحالة المحلية والعامة البسيطة.
  - **`Zustand`:** تستخدم لتخزين البيانات المرجعية المشتركة (مثل قوائم العملاء والموردين) في ذاكرة المتصفح لتقليل طلبات قاعدة البيانات المتكررة وتسريع التنقل.

- **النماذج (Forms):**
  - **`React Hook Form` & `Zod`:** لإدارة حالة النماذج والتحقق من صحة مخططات البيانات (Schema validation) في النماذج والخلفية.

### 3.2. هيكل الكود
- **`src/app`**: يحتوي على مسارات التطبيق الرئيسية (الصفحات). كل مجلد يمثل مسارًا ويحتوي على ملف `page.tsx` ومجلد `components` للمكونات الخاصة بالصفحة.
- **`src/app/(...)/actions.ts`**: ملفات Server Actions المسؤولة عن التفاعل مع قاعدة البيانات (قراءة، كتابة، حذف) من جهة الخادم بشكل آمن.
- **`src/components/ui`**: مكونات ShadCN UI الأساسية (Button, Card, Input...).
- **`src/components/layout`**: مكونات الهيكل العام للتطبيق مثل الشريط العلوي والجانبي.
- **`src/lib`**: يحتوي على الملفات المساعدة والأنواع (types) والاتصال بـ Firebase.
- **`src/context`**: مزودات السياق (Context Providers) مثل `AuthContext` و `ThemeCustomizationContext`.
- **`src/ai`**: يحتوي على منطق الذكاء الاصطناعي باستخدام Genkit، مقسم إلى `flows` لكل مهمة محددة.

---

## 4. تدفق البيانات والربط

### 4.1. الربط بين الصفحات
- **التنقل:** يتم باستخدام مكون `<Link>` من Next.js، مع تفعيل خاصية `prefetch` لتحميل الصفحات في الخلفية قبل النقر عليها، مما يسرّع الانتقال.
- **تمرير البيانات:** يتم بشكل أساسي عبر:
  - **`Query Parameters`**: لتمرير معرفات بسيطة في عنوان URL (مثال: `/reports/boxes?boxId=...`).
  - **`Route Segments`**: للمسارات الديناميكية (مثال: `/clients/[id]`).

### 4.2. الربط مع قاعدة البيانات
- **الاستعلام:** جميع عمليات القراءة والكتابة تتم حصرًا عبر **Server Actions** الموجودة في ملفات `actions.ts`. هذه الدوال تستدعي `getDb()` من `src/lib/firebase-admin.ts` للتفاعل مع Firestore.
- **الأمان:** استخدام Server Actions يضمن أن منطق التعامل مع قاعدة البيانات لا يتم كشفه للمتصفح، مما يزيد من الأمان.
- **التخزين المؤقت (Caching):**
  - يتم استخدام `React.cache` و `Zustand` لتخزين البيانات التي لا تتغير كثيرًا (مثل قائمة المستخدمين، الصناديق، العملاء) لتقليل عدد الاستعلامات المتكررة عند التنقل بين الصفحات.

---

## 5. المشاكل ونقاط التحسين

### 5.1. أداء الاستعلامات
- **الضعف:** بعض الاستعلامات، خاصة في التقارير المعقدة (`getAccountStatement`)، تقوم بجلب كميات كبيرة من البيانات من مجموعات متعددة (bookings, visas, journal-vouchers) ثم تقوم بالفلترة والمعالجة في الكود. هذا الأسلوب قد يصبح بطيئًا مع زيادة حجم البيانات.
- **التحسين المقترح:**
  - **Denormalization:** تخزين بعض البيانات المحسوبة مسبقًا أو المتكررة في مستندات Firestore لتقليل الحاجة إلى عمليات `JOIN` المعقدة على مستوى الكود.
  - **فهرسة مركبة (Composite Indexes):** التأكد من وجود فهارس مناسبة لجميع الاستعلامات التي تعتمد على `where` و `orderBy` في Firestore.

### 5.2. تجربة المستخدم (UX)
- **الضعف:** نماذج الإدخال المعقدة مثل "إضافة حجز" أو "سند قبض مخصص" قد تكون طويلة ومربكة للمستخدم الجديد.
- **التحسين المقترح:**
  - تقسيم النماذج الطويلة إلى خطوات (Multi-step forms).
  - توفير قيم افتراضية ذكية بناءً على إدخالات المستخدم السابقة.
  - تحسين عرض الجداول في الشاشات الصغيرة باستخدام تصميم متجاوب أفضل (مثلاً، تحويل الصفوف إلى بطاقات).

### 5.3. تكرار الكود
- **الضعف:** يوجد تكرار في منطق حساب الأرباح في أماكن متعددة (التقارير، لوحة التحكم).
- **التحسين المقترح:**
  - إنشاء دوال مساعدة (utility functions) مركزية لحساب الأرباح وإعادة استخدامها في جميع أنحاء التطبيق.
  - توحيد مكونات عرض الجداول باستخدام مكون `VirtualTable` عالي الأداء الذي تم إضافته مؤخرًا لضمان تجربة متسقة وسريعة.

---

## 6. التوثيق
- **`README.md`**: يقدم نظرة عامة أساسية عن المشروع.
- **`TECHNICAL_DOCUMENTATION.md` (هذا الملف)**: يوفر شرحًا فنيًا معمقًا.
- **التوثيق الداخلي:** بعض الملفات الهامة (مثل `src/ai/flows/...` و `src/lib/types.ts`) تحتوي على تعليقات JSDoc لشرح وظيفتها والمدخلات والمخرجات المتوقعة.
