# المستند الفني لآلية تسجيل الدخول والمصادقة

## 1. نظرة عامة

هذا المستند يشرح بالتفصيل آلية تسجيل الدخول، إنشاء الجلسات، والتحقق من الصلاحيات في النظام. الهدف هو توفير فهم عميق لكيفية عمل كل جزء من العملية لضمان الأمان والكفاءة.

---

## 2. تدفق عملية تسجيل الدخول (خطوة بخطوة)

العملية مقسمة بين **الواجهة الأمامية (Client)** و **الواجهة الخلفية (Server)**.

### **الخطوة 1: عرض نموذج تسجيل الدخول (Client)**

1.  **الملف:** `src/components/auth/login-form.tsx`
2.  **الآلية:**
    *   عندما يقوم المستخدم بإدخال بريده الإلكتروني، يتم استدعاء دالة `getUserByEmail` من الخادم لجلب تفاصيل المستخدم (الاسم، الدور، إلخ) وعرضها في بطاقة معلومات أنيقة.
    *   يقوم المستخدم بإدخال كلمة المرور.

### **الخطوة 2: إرسال بيانات الدخول (Client -> Server)**

1.  **الملف:** `src/lib/auth-context.tsx`
2.  **الآلية:**
    *   عندما يضغط المستخدم على زر "تسجيل الدخول"، يتم استدعاء دالة `signIn`.
    *   تستخدم هذه الدالة بريد المستخدم الإلكتروني وكلمة المرور لاستدعاء `signInWithEmailAndPassword` من مكتبة Firebase Authentication الخاصة بالمتصفح.
    *   تتصل مكتبة Firebase مباشرة بخوادم Firebase للتحقق من صحة بيانات الاعتماد.

### **الخطوة 3: إنشاء الجلسة (Server)**

1.  **الملفات:** `src/lib/auth-context.tsx` و `src/lib/auth/actions.ts`
2.  **الآلية:**
    *   بعد نجاح المصادقة في الخطوة السابقة، يتم تفعيل مستمع `onIdTokenChanged` في `AuthContext`.
    *   هذا المستمع يحصل على `idToken` الخاص بالمستخدم، وهو بمثابة إثبات هوية مؤقت ومشفّر.
    *   يتم إرسال هذا الـ `idToken` إلى دالة خادم (`Server Action`) تسمى `createSessionCookie`.
    *   **داخل `createSessionCookie`:**
        1.  **التحقق من الـ Token:** يستخدم Firebase Admin SDK للتحقق من صحة الـ `idToken`.
        2.  **إنشاء Session Cookie:** يتم إنشاء "كعكة جلسة" (Session Cookie) آمنة وموقعة. هذه الـ Cookie هي التي سيعتمد عليها النظام لمعرفة هوية المستخدم في الطلبات اللاحقة.
        3.  **إرسال الـ Cookie للمتصفح:** يتم إرسال الـ Session Cookie إلى متصفح المستخدم وتخزينها بأمان.

    > **ملاحظة أمنية هامة:** يتم ضبط الـ Cookie بالخصائص `HttpOnly` (لمنع الوصول إليها عبر JavaScript)، `Secure` (لضمان إرسالها فقط عبر HTTPS في بيئة الإنتاج)، و `SameSite=Strict` (للحماية من هجمات CSRF).

### **الخطوة 4: التحقق من الجلسة مع كل طلب (Server - Middleware)**

1.  **الملف:** `src/middleware.ts`
2.  **الآلية:**
    *   مع كل طلب جديد من المستخدم (مثل الانتقال إلى صفحة جديدة)، يقوم الـ Middleware باعتراض الطلب.
    *   يتحقق من وجود الـ Session Cookie.
    *   **إذا لم تكن موجودة**، يتم توجيه المستخدم إلى صفحة تسجيل الدخول.
    *   **إذا كانت موجودة**، يتم السماح للمستخدم بالوصول للصفحة المطلوبة.

### **الخطوة 5: التحقق من الصلاحيات (Server)**

1.  **الملفات:** `src/lib/auth-context.tsx` و `src/lib/auth/permissions.ts`
2.  **الآلية:**
    *   عند عرض أي صفحة محمية أو تنفيذ أي إجراء يتطلب صلاحية معينة، يتم استخدام دالة `hasPermission` المتوفرة في `useAuth`.
    *   تقوم هذه الدالة بالتحقق من الصلاحيات المخزنة في بيانات المستخدم التي تم جلبها من الخادم.
    *   إذا كانت الصلاحية المطلوبة موجودة، يتم عرض المحتوى أو تنفيذ الإجراء. وإلا، يتم عرض رسالة "وصول مرفوض".

---

## 3. تحسينات أمنية ومستقبلية

### **تجديد الجلسة (Session Refresh)**
لتحسين تجربة المستخدم، يمكن إضافة آلية لتجديد الـ Session Cookie تلقائيًا قبل انتهاء صلاحيتها طالما أن المستخدم نشط، وذلك لتجنب تسجيل الخروج المفاجئ.

### **الحماية من هجمات CSRF**
على الرغم من أن `SameSite=Strict` توفر حماية جيدة، إلا أنه يمكن تعزيز الأمان أكثر عن طريق إضافة CSRF Tokens للنماذج والإجراءات الحساسة (POST, PUT, DELETE) في المستقبل.

---

## 4. تصحيح الأخطاء ومشاكل شائعة

### **مشكلة فقدان تسجيل الدخول في بيئات الـ Preview**
*   **المشكلة:** عند تجربة الموقع داخل بيئات التطوير مثل (Firebase Studio Preview, Vercel Preview)، قد تلاحظ أن تسجيل الدخول لا يستمر بعد تحديث الصفحة.
*   **السبب:** تعمل هذه البيئات غالبًا داخل `iframe`، مما يفرض قيودًا أمنية على المتصفحات تمنع حفظ أو الوصول إلى الـ Cookies بشكل صحيح.
*   **الحل:** لتجربة آلية تسجيل الدخول بشكل صحيح، يجب فتح الموقع في **نافذة متصفح مستقلة**، وليس داخل بيئة preview المدمجة.

---

## 5. مخطط تدفق البيانات (Data Flow Diagram)

```
[المستخدم] --1. إدخال البريد والرمز--> [الواجهة الأمامية (Client)]
     |                                        |
     |                                        |--2. إرسال إلى Firebase Auth--> [Firebase]
     |                                        |                                  |
     |                                        |<--3. إرجاع idToken---------- [Firebase]
     |                                        |
     |                                        |--4. إرسال idToken----------> [الخادم (Server)]
     |                                        |                                  |
     |                                        |                                  |--5. التحقق من Token وإنشاء Session Cookie
     |                                        |                                  |
     |<--------------------------------------6. إرسال Cookie للمتصفح------ [الخادم (Server)]
     |
[المستخدم] --7. إرسال طلب جديد مع Cookie--> [الخادم (Middleware)]
     |                                        |
     |                                        |--8. التحقق من صلاحية Cookie
     |                                        |
     |<-----------------------------------9. عرض الصفحة أو التوجيه------- [الخادم (Middleware)]
```

---

## 6. ملخص الآلية

| الخطوة | الواجهة (Client) | الخادم (Server) | النتيجة |
| :--- | :--- | :--- | :--- |
| **1. العرض** | يعرض `login-form` ويطلب بيانات المستخدم عند إدخال البريد. | `getUserByEmail` تجلب بيانات المستخدم وتعيدها. | عرض تفاصيل المستخدم (الاسم، الدور، إلخ). |
| **2. المصادقة** | يرسل `email` و `password` إلى Firebase Auth. | | التحقق من صحة كلمة المرور وإصدار `idToken`. |
| **3. إنشاء الجلسة** | `onIdTokenChanged` يرسل `idToken` إلى `createSessionCookie`. | يتحقق من الـ `idToken` وينشئ Session Cookie آمنة. | تخزين Cookie آمنة في المتصفح. |
| **4. حماية الصفحات** | يرسل الـ Cookie مع كل طلب صفحة. | `middleware.ts` يتحقق من وجود الـ Cookie. | توجيه المستخدم غير المسجل إلى صفحة الدخول. |
| **5. حماية الإجراءات** | المكونات تستدعي `hasPermission` قبل عرض المحتوى الحساس. | `getUserById` تجلب بيانات المستخدم وصلاحياته. | عرض المحتوى أو منعه بناءً على صلاحيات المستخدم. |
