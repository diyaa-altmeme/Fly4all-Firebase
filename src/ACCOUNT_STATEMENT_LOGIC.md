# المستند الفني لوحدة كشف الحساب التحليلي

## 1. نظرة عامة

هذا المستند يشرح بالتفصيل آلية العمل المكتشفة والمطبقة في صفحة كشف الحساب التحليلي (`src/app/reports/account-statement/page.tsx`). الهدف هو توثيق المنطق المعقد لجلب البيانات لضمان سهولة الصيانة والتطوير المستقبلي، وتجنب الأخطاء التي واجهناها سابقًا.

---

## 2. آلية جلب البيانات المكتشفة (Data Flow)

بعد تحليل معمق، تبين أن بنية البيانات لا تسمح بربط مباشر بين العميل والقيد المحاسبي. الآلية الصحيحة أكثر تعقيدًا وتعتمد على "مستند وسيط".

### آلية عمل كشف حساب العملاء (Relations)

تتبع العملية تدفقًا من 3 خطوات رئيسية يُعرف بـ "الجسر":

1.  **الخطوة الأولى: الاستعلام عن القيود المحاسبية**
    *   يتم جلب جميع المستندات من مجموعة `journal-vouchers` ضمن النطاق الزمني المحدد.
    *   **فلتر أساسي:** يتم التركيز فقط على القيود التي تؤثر على حساب **"الذemm المدينة (العملاء)"** الموحّد (ID: `QmqPujiHb8fo68jb4MbP`).

2.  **الخطوة الثانية: عبور الجسر إلى المستند المصدر**
    *   لكل قيد محاسبي، يقوم النظام بقراءة حقلي `sourceType` و `sourceId`.
    *   يتم استخدام هذه المعلومات لجلب **المستند المصدر** الأصلي (مثل مستند من مجموعة `segments` أو `visas`).

3.  **الخطوة الثالثة: التحقق من هوية العميل**
    *   يقوم النظام بفحص المستند المصدر الذي تم جلبه في الخطوة السابقة.
    *   يتم البحث عن حقل `clientId` أو التحقق مما إذا كان العميل المختار هو أحد الشركاء (`partners`) في ذلك المستند.
    *   إذا تطابقت هوية العميل، يتم اعتبار القيد المحاسبي تابعًا لهذا العميل ويُعرض في الجدول.

### آلية عمل الحسابات الأخرى (الصناديق، المصاريف، إلخ)

الآلية هنا أبسط بكثير:
1.  يتم الاستعلام عن مجموعة `journal-vouchers` ضمن النطاق الزمني.
2.  يتم فلترة النتائج مباشرة لعرض القيود التي تحتوي على `accountId` مطابق لمعرّف الحساب المختار (صندوق، حساب مصروف، إلخ).

---

## 3. اعتبارات الأداء التي تم حلها

### **مشكلة الاستعلام غير المحدود (Unbounded Query)**

*   **المشكلة:** كان الكود الأولي يحاول جلب جميع القيود المحاسبية منذ بداية تأسيس النظام في حال عدم تحديد تاريخ، مما يؤدي إلى تجميد الواجهة بالكامل.
*   **الحل:** تم فرض **نطاق زمني افتراضي** عند تحميل الصفحة (من بداية الشهر الحالي إلى اليوم). هذا يضمن أن تكون الصفحة سريعة ومستجيبة دائمًا، مع ترك الحرية للمستخدم لتغيير هذا النطاق.

---

## 4. ملخص التغييرات في الواجهة (UI Changes)

لتحسين تجربة المستخدم وتحقيق المتطلبات، تم إجراء التعديلات التالية على واجهة المستخدم:

*   **إضافة أعمدة جديدة:** تم إضافة الأعمدة التالية للجدول:
    *   **رقم الفاتورة:** لعرض رقم المستند المصدر.
    *   **المستخدم:** لعرض اسم المستخدم الذي أنشأ القيد.
    *   **الملاحظات:** لعرض تفاصيل إضافية من القيد.
    *   **الإجراءات:** يحتوي على زر لفتح المستند المصدر الأصلي في نافذة جديدة.
*   **ترجمة أنواع العمليات:** تم إنشاء قاموس (`moduleTranslations`) لترجمة أنواع العمليات من الإنجليزية (e.g., `segment`) إلى العربية (e.g., "سكمنت").
*   **عرض اسم المستخدم:** تم ربط `createdBy` (الذي يكون ID) مع قائمة المستخدمين لعرض الاسم الكامل بدلاً من المعرّف.
*   **إصلاح رابط الإجراءات:** تم تحديث كود مكون `Link` ليعمل بالطريقة الصحيحة ويتوافق مع أحدث إصدارات Next.js.
