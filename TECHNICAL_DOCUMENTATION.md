# المستند الفني لآلية تسجيل الدخول والمصادقة

## 1. نظرة عامة

هذا المستند يشرح بالتفصيل آلية تسجيل الدخول، إنشاء الجلسات، والتحقق من الصلاحيات في النظام. الهدف هو توفير فهم عميق لكيفية عمل كل جزء من العملية لضمان الأمان والكفاءة.

---

## 2. تدفق عملية تسجيل الدخول ( خطوة بخطوة)

العملية مقسمة بين **الواجهة الأمامية (Client)** و **الواجهة الخلفية (Server)**.

### **الخطوة 1: عرض نموذج تسجيل الدخول (Client)**

1.  **الملف:** `src/components/auth/login-form.tsx`
2.  **الآلية:**
    *   عند تحميل الصفحة، يقوم المكون بإرسال طلب إلى مسار API داخلي (`/api/users`).
    *   مسار الـ API هذا (الموجود في `src/app/api/users/route.ts`) يعمل على الخادم ويقوم باستدعاء دالة `getUsers()` لجلب قائمة جميع المستخدمين (UID والاسم) من قاعدة بيانات Firestore بشكل آمن.
    *   يتم عرض أسماء المستخدمين في قائمة منسدلة (`Autocomplete`) ليختار المستخدم اسمه منها.
    *   يقوم المستخدم بإدخال كلمة المرور.

### **الخطوة 2: إرسال بيانات الدخول (Client -> Server)**

1.  **الملف:** `src/lib/auth-context.tsx`
2.  **الآلية:**
    *   عندما يضغط المستخدم على زر "تسجيل الدخول"، يتم استدعاء دالة `signIn`.
    *   تستخدم هذه الدالة بريد المستخدم الإلكتروني (الذي تم جلبه مع قائمة المستخدمين) وكلمة المرور التي أدخلها لاستدعاء `signInWithEmailAndPassword` من مكتبة Firebase Authentication الخاصة بالمتصفح.
    *   تتصل مكتبة Firebase مباشرة بخوادم Firebase للتحقق من صحة بيانات الاعتماد.

### **الخطوة 3: إنشاء الجلسة وتضمين الصلاحيات (Server)**

1.  **الملفات:** `src/lib/auth-context.tsx` و `src/lib/auth/actions.ts`
2.  **الآلية:**
    *   بعد نجاح المصادقة في الخطوة السابقة، يتم تفعيل مستمع `onIdTokenChanged` في `AuthContext`.
    *   هذا المستمع يحصل على `idToken` الخاص بالمستخدم، وهو بمثابة إثبات هوية مؤقت ومشفّر.
    *   يتم إرسال هذا الـ `idToken` إلى دالة خادم (`Server Action`) تسمى `createSessionCookie`.
    *   **داخل `createSessionCookie` (وهذه هي النقطة الأهم):**
        1.  **التحقق من الـ Token:** يستخدم Firebase Admin SDK للتحقق من صحة الـ `idToken`.
        2.  **جلب بيانات المستخدم الكاملة:** باستخدام `uid` الموجود في الـ Token، يتم جلب بيانات المستخدم الكاملة من مجموعة `users` في Firestore، بما في ذلك حقل `role` (مثل "admin", "editor").
        3.  **جلب الصلاحيات:** بناءً على `role` المستخدم، يتم جلب قائمة الصلاحيات (`permissions`) الخاصة بهذا الدور من مجموعة `roles`.
        4.  **إنشاء Claims مخصصة:** يتم إنشاء "مطالبات مخصصة" (Custom Claims) تحتوي على `role` و `permissions`.
        5.  **إنشاء Session Cookie:** يتم إنشاء "كعكة جلسة" (Session Cookie) آمنة وموقعة، ويتم تضمين الـ Custom Claims بداخلها. هذه الـ Cookie هي التي سيعتمد عليها النظام لمعرفة هوية المستخدم وصلاحياته في الطلبات اللاحقة.
        6.  **إرسال الـ Cookie للمتصفح:** يتم إرسال الـ Session Cookie إلى متصفح المستخدم وتخزينها بأمان.

### **الخطوة 4: التحقق من الجلسة مع كل طلب (Server - Middleware)**

1.  **الملف:** `src/middleware.ts`
2.  **الآلية:**
    *   مع كل طلب جديد من المستخدم (مثل الانتقال إلى صفحة جديدة)، يقوم الـ Middleware باعتراض الطلب.
    *   يتحقق من وجود الـ Session Cookie. إذا لم تكن موجودة، يتم توجيه المستخدم إلى صفحة تسجيل الدخول.
    *   إذا كانت موجودة، يمكن (في المستقبل) فك تشفيرها على مستوى الـ Middleware للتحقق السريع من الصلاحيات قبل الوصول للصفحة.

### **الخطوة 5: تطبيق قواعد الأمان في قاعدة البيانات (Server - Firestore Rules)**

1.  **الملف:** `firestore.rules`
2.  **الآلية:**
    *   عندما يحاول الكود (من خلال `Server Action`) القراءة من قاعدة البيانات أو الكتابة إليها، تقوم قواعد Firestore بالتحقق من الـ Session Cookie تلقائيًا.
    *   نستخدم دالة `hasPermission(permission)` التي كتبناها داخل القواعد.
    *   هذه الدالة تتحقق من `request.auth.token.permissions` (التي قمنا بتضمينها في الخطوة 3) لمعرفة ما إذا كانت الصلاحية المطلوبة موجودة.
    *   إذا كانت الصلاحية موجودة، تسمح بالعملية. وإلا، ترفضها، مما يضمن حماية كاملة للبيانات.

---

## 3. ملخص الآلية

| الخطوة | الواجهة (Client) | الخادم (Server) | النتيجة |
| :--- | :--- | :--- | :--- |
| **1. العرض** | يعرض `login-form` ويطلب قائمة المستخدمين من `/api/users`. | `getUsers()` تجلب أسماء المستخدمين وتعيدها. | عرض قائمة المستخدمين في النموذج. |
| **2. المصادقة** | يرسل `email` و `password` إلى Firebase Auth. | | التحقق من صحة كلمة المرور. |
| **3. إنشاء الجلسة** | `onIdTokenChanged` يرسل `idToken` إلى `createSessionCookie`. | يتحقق من الـ Token، يجلب الدور والصلاحيات، ينشئ Session Cookie مع الـ Claims. | تخزين Cookie آمنة في المتصفح تحتوي على كل صلاحيات المستخدم. |
| **4. حماية الصفحات** | يرسل الـ Cookie مع كل طلب صفحة. | `middleware.ts` يتحقق من وجود الـ Cookie. | توجيه المستخدم غير المسجل إلى صفحة الدخول. |
| **5. حماية البيانات** | `Server Action` تحاول الوصول للبيانات. | `firestore.rules` تتحقق من الصلاحيات داخل الـ Cookie. | السماح أو رفض الوصول للبيانات بناءً على صلاحيات المستخدم. |
